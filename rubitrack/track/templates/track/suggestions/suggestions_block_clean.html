{% load static %}

<div id="suggestions-block" class="suggestions-container" 
     data-track-id="{% if current_track %}{{ current_track.id }}{% endif %}"
     data-ajax-url="{% url 'ajax_suggestions' %}">
    <h3>Suggestions pour : 
        {% if current_track %}
            <span class="artist_green_flashy">{{ current_track.artist.name }}</span> - {{ current_track.title }}
            <br><small class="track-info">Genre: {{ current_track.genre.name|default:"Unknown" }} | BPM: {{ current_track.bpm|floatformat:1|default:"--" }}</small>
        {% endif %}
    </h3>
    
    <!-- Contrôles de filtrage -->
    <div class="suggestions-controls">
        <div class="control-group">
            <label for="bpm-range-slider">BPM Range (±<span id="bpm-range-value">{{ bpm_range|default:"3" }}</span>%)</label>
            <input type="range" id="bpm-range-slider" min="0" max="20" value="{{ bpm_range|default:"3" }}" class="slider">
        </div>
        
        <div class="control-group">
            <fieldset>
                <legend>Genre Filter:</legend>
                <div class="radio-group">
                    <input type="radio" id="genre-exact" name="genre-mode" value="exact" checked>
                    <label for="genre-exact">Exact</label>
                    
                    <input type="radio" id="genre-secondary" name="genre-mode" value="secondary">
                    <label for="genre-secondary">Secondary</label>
                </div>
            </fieldset>
        </div>
        
        <div class="suggestions-count">
            <span id="suggestions-count">{{ suggestions|length }}</span> suggestions trouvées
        </div>
    </div>
    
    <!-- Table des suggestions -->
    <div class="suggestions-table-container">
        <table class="suggestions-table" id="suggestions-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="title">
                        Track 
                        <span class="sort-indicator" data-field="title"></span>
                    </th>
                    <th class="sortable" data-sort="artist">
                        Artist 
                        <span class="sort-indicator" data-field="artist"></span>
                    </th>
                    <th class="sortable" data-sort="bpm">
                        BPM 
                        <span class="sort-indicator" data-field="bpm"></span>
                    </th>
                    <th class="sortable" data-sort="musical_key">
                        Key 
                        <span class="sort-indicator" data-field="musical_key"></span>
                    </th>
                    <th class="sortable" data-sort="genre">
                        Genre 
                        <span class="sort-indicator" data-field="genre"></span>
                    </th>
                    <th class="sortable" data-sort="comment">
                        Comment 
                        <span class="sort-indicator" data-field="comment"></span>
                    </th>
                    <th class="sortable" data-sort="ranking">
                        Ranking 
                        <span class="sort-indicator" data-field="ranking"></span>
                    </th>
                    <th class="sortable" data-sort="playcount">
                        Playcount 
                        <span class="sort-indicator" data-field="playcount"></span>
                    </th>
                </tr>
            </thead>
            <tbody id="suggestions-tbody">
                {% for suggestion in suggestions %}
                    <tr class="suggestion-row" data-track-id="{{ suggestion.id }}">
                        <td class="track-title">{{ suggestion.title }}</td>
                        <td class="track-artist">
                            <span class="artist_green_flashy">{{ suggestion.artist.name }}</span>
                        </td>
                        <td class="track-bpm">{% if suggestion.bpm %}{{ suggestion.bpm|floatformat:1 }}{% else %}--{% endif %}</td>
                        <td class="track-key">{{ suggestion.musical_key|default:"--" }}</td>
                        <td class="track-genre">{{ suggestion.genre.name|default:"--" }}</td>
                        <td class="track-comment">{{ suggestion.comment|default:"--"|truncatewords:3 }}</td>
                        <td class="track-ranking">
                            {% if suggestion.ranking %}
                                <span class="ranking-stars">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= suggestion.ranking %}★{% else %}☆{% endif %}
                                    {% endfor %}
                                </span>
                            {% else %}
                                --
                            {% endif %}
                        </td>
                        <td class="track-playcount">{{ suggestion.playcount|default:"0" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="no-suggestions">Aucune suggestion trouvée</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.suggestions-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.track-info {
    color: #666;
    font-weight: normal;
    font-size: 0.7em;
    margin-left: 10px;
}

.suggestions-controls {
    display: flex;
    align-items: center;
    gap: 30px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.control-group label {
    font-weight: bold;
    font-size: 12px;
    color: #666;
}

.slider {
    width: 120px;
    height: 5px;
    border-radius: 5px;
    background: #d3d3d3;
    outline: none;
}

.slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #52d3aa;
    cursor: pointer;
}

.radio-group {
    display: flex;
    gap: 15px;
    align-items: center;
}

.radio-group input[type="radio"] {
    margin-right: 5px;
}

.suggestions-count {
    margin-left: auto;
    font-size: 14px;
    color: #666;
    font-weight: bold;
}

.suggestions-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.suggestions-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.suggestions-table th {
    background: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
}

.suggestions-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.suggestions-table th.sortable:hover {
    background: #e9ecef;
}

.sort-indicator {
    position: absolute;
    right: 5px;
    font-size: 12px;
    color: #666;
}

.sort-indicator:after {
    content: "↕";
}

.sort-indicator.asc:after {
    content: "↑";
    color: #52d3aa;
}

.sort-indicator.desc:after {
    content: "↓";
    color: #52d3aa;
}

.suggestions-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #f0f0f0;
}

.suggestion-row:hover {
    background: #f8f9fa;
    cursor: pointer;
}

.track-title {
    font-weight: 500;
}

.artist_green_flashy {
    color: #52d3aa;
    font-weight: normal;
}

.track-bpm, .track-key, .track-ranking, .track-playcount {
    text-align: center;
    width: 80px;
}

.ranking-stars {
    color: #ffc107;
    font-size: 14px;
}

.no-suggestions {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* Couleurs BPM */
.bpm-higher { color: #dc3545; }  /* Rouge pour BPM plus élevé */
.bpm-lower { color: #28a745; }   /* Vert pour BPM plus bas */
.bpm-similar { color: #007bff; } /* Bleu pour BPM similaire */
.bpm-neutral { color: #6c757d; } /* Gris pour neutral */

/* Responsive */
@media (max-width: 768px) {
    .suggestions-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .suggestions-count {
        margin-left: 0;
        text-align: center;
    }
    
    .suggestions-table {
        font-size: 14px;
    }
    
    .suggestions-table th,
    .suggestions-table td {
        padding: 8px 4px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const suggestionsBlock = document.getElementById('suggestions-block');
    const bpmSlider = document.getElementById('bpm-range-slider');
    const bpmValue = document.getElementById('bpm-range-value');
    const genreRadios = document.querySelectorAll('input[name="genre-mode"]');
    const suggestionsCount = document.getElementById('suggestions-count');
    const suggestionsTable = document.getElementById('suggestions-table');
    const sortableHeaders = document.querySelectorAll('.sortable');
    
    let currentSort = { field: 'playcount', order: 'desc' };
    const currentTrackId = {{ current_track.id|default:"null" }};
    
    // Mise à jour de la valeur du slider BPM
    if (bpmSlider && bpmValue) {
        bpmSlider.addEventListener('input', function() {
            bpmValue.textContent = this.value;
            updateSuggestions();
        });
    }
    
    // Gestion des radio buttons genre
    genreRadios.forEach(radio => {
        radio.addEventListener('change', updateSuggestions);
    });
    
    // Gestion du tri des colonnes
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const field = this.dataset.sort;
            
            // Inverser l'ordre si on clique sur la même colonne
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            
            updateSortIndicators();
            updateSuggestions();
        });
    });
    
    function updateSortIndicators() {
        // Réinitialiser tous les indicateurs
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.className = 'sort-indicator';
        });
        
        // Mettre à jour l'indicateur actuel
        const activeIndicator = document.querySelector(`[data-field="${currentSort.field}"]`);
        if (activeIndicator) {
            activeIndicator.className = `sort-indicator ${currentSort.order}`;
        }
    }
    
    function updateSuggestions() {
        if (!currentTrackId) return;
        
        const bpmRange = parseInt(bpmSlider.value);
        const genreMode = document.querySelector('input[name="genre-mode"]:checked').value;
        
        const requestData = {
            track_id: currentTrackId,
            bpm_range: bpmRange,
            genre_mode: genreMode,
            sort_by: currentSort.field,
            sort_order: currentSort.order
        };
        
        fetch('{% url "ajax_suggestions" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            updateSuggestionsTable(data.suggestions);
            suggestionsCount.textContent = data.count;
        })
        .catch(error => {
            console.error('Erreur lors de la récupération des suggestions:', error);
        });
    }
    
    function updateSuggestionsTable(suggestions) {
        const tbody = document.getElementById('suggestions-tbody');
        
        if (suggestions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-suggestions">Aucune suggestion trouvée</td></tr>';
            return;
        }
        
        tbody.innerHTML = suggestions.map(suggestion => `
            <tr class="suggestion-row" data-track-id="${suggestion.id}">
                <td class="track-title">${suggestion.title}</td>
                <td class="track-artist">
                    <span class="artist_green_flashy">${suggestion.artist}</span>
                </td>
                <td class="track-bpm ${suggestion.bpm_color_class}">${suggestion.bpm ? parseFloat(suggestion.bpm).toFixed(1) : '--'}</td>
                <td class="track-key">${suggestion.musical_key || '--'}</td>
                <td class="track-genre">${suggestion.genre || '--'}</td>
                <td class="track-comment">${suggestion.comment ? suggestion.comment.substring(0, 30) + (suggestion.comment.length > 30 ? '...' : '') : '--'}</td>
                <td class="track-ranking">
                    ${suggestion.ranking ? 
                        '★'.repeat(suggestion.ranking) + '☆'.repeat(5 - suggestion.ranking) : 
                        '--'
                    }
                </td>
                <td class="track-playcount">${suggestion.playcount || '0'}</td>
            </tr>
        `).join('');
        
        // Ajouter les événements de clic sur les nouvelles lignes
        tbody.querySelectorAll('.suggestion-row').forEach(row => {
            row.addEventListener('click', function() {
                const trackId = this.dataset.trackId;
                // Ici vous pouvez ajouter l'action à effectuer lors du clic
                console.log('Track sélectionnée:', trackId);
            });
        });
    }
    
    // Initialiser les indicateurs de tri
    updateSortIndicators();
});
</script>
