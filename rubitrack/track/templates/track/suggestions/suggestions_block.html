{% load static %}
{% load musical_key_filters %}

<div id="suggestions-block" class="suggestions-container" 
     data-track-id="{% if current_track %}{{ current_track.id }}{% endif %}"
     data-ajax-url="{% url 'ajax_suggestions' %}">
    
    <h3>Suggestions pour : 
        {% if current_track %}
            <span class="artist_green_flashy">{{ current_track.artist.name }}</span> - {{ current_track.title }}
            <br><small class="track-info">
                {{ current_track.genre.name|default:"--" }} - 
                {{ current_track.bpm|floatformat:1|default:"--" }} BPM - 
                {% if current_track.musical_key %}
                    {% musical_key_badge current_track.musical_key %}
                {% else %}
                    <span class="no-key">--</span>
                {% endif %}
            </small>
        {% endif %}
    </h3>
    
    <!-- Contrôles de filtrage -->
    <div class="suggestions-controls">
        <div class="control-group">
            <label for="bpm-range-slider">BPM Range (±<span id="bpm-range-value">{{ bpm_range|default:3 }}</span>%)</label>
            <input type="range" id="bpm-range-slider" min="0" max="20" value="{{ bpm_range|default:3 }}" class="slider">
        </div>
        
        <div class="control-group">
            <label for="ranking-slider">Min Ranking (<span id="ranking-value">{{ default_ranking_min|default:3 }}</span> ★)</label>
            <input type="range" id="ranking-slider" min="0" max="5" value="{{ default_ranking_min|default:3 }}" class="slider">
        </div>
        
        <div class="control-group">
            <fieldset>
                <legend>Genre Filter:</legend>
                <div class="radio-group">
                    <input type="radio" id="genre-same" name="genre-mode" value="same" checked>
                    <label for="genre-same">Same</label>
                    <input type="radio" id="genre-secondary" name="genre-mode" value="secondary">
                    <label for="genre-secondary">Secondary</label>
                </div>
            </fieldset>
        </div>
    </div>

    <!-- Résultats -->
    <div class="suggestions-results">
        <div class="suggestions-header">
            <span id="suggestions-count">0</span> suggestions trouvées
        </div>
        
        <div class="table-container">
            <table id="suggestions-table" class="suggestions-table">
                <thead>
                    <tr>
                        <th class="sortable" data-field="artist__name">Artist</th>
                        <th class="sortable" data-field="title">Title</th>
                        <th class="sortable" data-field="genre__name">Genre</th>
                        <th class="sortable" data-field="bpm">BPM</th>
                        <th class="sortable" data-field="musical_key">Musical Key</th>
                        <th class="sortable" data-field="traktor_order">Traktor Order</th>
                        <th class="sortable" data-field="comment">Comment</th>
                        <th class="sortable" data-field="ranking">Ranking</th>
                        <th class="sortable" data-field="playcount">Playcount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les suggestions seront chargées ici par AJAX -->
                </tbody>
            </table>
        </div>
        
        <div id="no-suggestions" class="no-suggestions" style="display: none;">
            Aucune suggestion trouvée avec les critères actuels.
        </div>
    </div>
</div>

<style>
.suggestions-container {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.suggestions-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
}

.control-group {
    flex: 1;
    min-width: 200px;
}

.control-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.slider {
    width: 100%;
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
}

.radio-group {
    display: flex;
    gap: 15px;
    margin-top: 5px;
}

.suggestions-header {
    margin-bottom: 10px;
    font-weight: bold;
    color: #666;
}

.table-container {
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.suggestions-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}

.suggestions-table th,
.suggestions-table td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.suggestions-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}

.suggestions-table th.sortable {
    cursor: pointer;
}

.suggestions-table th.sortable:hover {
    background-color: #e9ecef;
}

.track-row:hover {
    background-color: #f5f5f5;
}

.genre-badge, .musical-key-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    background-color: #6c757d;
}

.musical-key-badge {
    background-color: #17a2b8;
}

.ranking-stars {
    color: #ffc107;
    font-size: 14px;
}

.no-suggestions {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const suggestionsBlock = document.getElementById('suggestions-block');
    const bpmSlider = document.getElementById('bpm-range-slider');
    const bpmValue = document.getElementById('bpm-range-value');
    const rankingSlider = document.getElementById('ranking-slider');
    const rankingValue = document.getElementById('ranking-value');
    const genreRadios = document.querySelectorAll('input[name="genre-mode"]');
    const suggestionsCount = document.getElementById('suggestions-count');
    const suggestionsTable = document.getElementById('suggestions-table');
    
    let currentSort = { field: 'playcount', order: 'desc' };
    
    // Récupération du track ID depuis les données du template
    const trackIdElement = suggestionsBlock.dataset.trackId;
    const currentTrackId = trackIdElement ? parseInt(trackIdElement) : null;
    
    // Mise à jour des sliders
    if (bpmSlider && bpmValue) {
        bpmSlider.addEventListener('input', function() {
            bpmValue.textContent = this.value;
            updateSuggestions();
        });
    }
    
    if (rankingSlider && rankingValue) {
        rankingSlider.addEventListener('input', function() {
            rankingValue.textContent = this.value;
            updateSuggestions();
        });
    }
    
    // Gestion des radio buttons
    genreRadios.forEach(radio => {
        radio.addEventListener('change', updateSuggestions);
    });
    
    function updateSuggestions() {
        if (!currentTrackId) return;
        
        const bpmRange = parseInt(bpmSlider.value);
        const rankingMin = parseInt(rankingSlider.value);
        const genreMode = document.querySelector('input[name="genre-mode"]:checked').value;
        
        const requestData = {
            track_id: currentTrackId,
            bpm_range: bpmRange,
            ranking_min: rankingMin,
            genre_mode: genreMode,
            sort_by: currentSort.field,
            sort_order: currentSort.order
        };
        
        fetch(suggestionsBlock.dataset.ajaxUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            updateSuggestionsTable(data.suggestions);
            suggestionsCount.textContent = data.count;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    function updateSuggestionsTable(suggestions) {
        const tbody = suggestionsTable.querySelector('tbody');
        tbody.innerHTML = '';
        
        suggestions.forEach(track => {
            const row = document.createElement('tr');
            row.className = 'track-row';
            
            let rankingStars = '';
            for (let i = 1; i <= 5; i++) {
                rankingStars += i <= track.ranking ? '★' : '☆';
            }
            
            let musicalKeyOrder = (typeof track.musical_key_order !== 'undefined' && track.musical_key_order !== null) ? ` (${track.musical_key_order})` : '';
            let musicalKeyBadge = track.musical_key ? 
                `<span class="musical-key-badge" style="background-color: ${track.musical_key_color}; color: white; font-weight: bold; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${track.musical_key}</span>` : '--';
            let keyDistance = (typeof track.musical_key_distance !== 'undefined' && track.musical_key_distance !== null) ? 
                `<span style='color:#888;font-size:10px;margin-left:4px;'>${track.musical_key_distance}${musicalKeyOrder}</span>` : musicalKeyOrder;
            
            row.innerHTML = `
                <td>${track.artist_name}</td>
                <td>${track.title}</td>
                <td><span class="genre-badge">${track.genre_name || '--'}</span></td>
                <td>${track.bpm ? parseFloat(track.bpm).toFixed(1) : '--'}</td>
                <td>${musicalKeyBadge}${keyDistance}</td>
                <td>${track.musical_key_order !== undefined && track.musical_key_order !== null ? track.musical_key_order : '--'}</td>
                <td>${track.comment || '--'}</td>
                <td><span class="ranking-stars">${rankingStars}</span></td>
                <td>${track.playcount || 0}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Charger les suggestions initiales
    if (currentTrackId) {
        updateSuggestions();
    }
});
</script>
