{% extends 'admin/base_site.html' %}
{% block title %}Track Duplicates{% endblock title %}
{% block content %}
<h1>Tracks Duplicates</h1>
<!-- <a href="/track/manual_merge_artist"><div class="green_flashy">Merge Artists</div></a>
<br> -->
<form id="bulk-merge-form" method="post" action="{% url 'bulk_merge_tracks' %}">
    {% csrf_token %}

    <!-- Action buttons at the top -->
    <div style="margin-top:20px; text-align:center;">
        <button type="button" id="bulk-merge-btn" onclick="bulkMerge()" class="btn btn-success" style="background-color:#28a745; color:white; border:none; margin-right:10px;">
            Merge selected (0)
        </button>
        <a href="{% url 'manual_merge_duplicate' %}" class="btn btn-danger" style="margin-right:10px;">Merge 2 tracks manually</a>
        <a href="{% url 'manual_merge_artist' %}" class="btn btn-warning" style="background-color:#ffc107; color:black; border:none;">Merge 2 artists manually</a>
    </div>

    <br>

    <table>
        <tr>
            <th style="text-align:left;">
                <input type="checkbox" id="select-all" onclick="toggleSelectAll(this)"> Select
            </th>
            <th style="text-align:left;">Artist</th>
            <th style="text-align:left;">Title A (long)</th>
            <th style="text-align:left;">Title B (short)</th>
            <th>Individual Action</th>
        </tr>
        {% for track_a, track_b in duplicates %}
        <tr>
            <td style="text-align:left;">
                <input type="checkbox" name="merge_pairs" value="{{ track_a.id }},{{ track_b.id }}" class="merge-checkbox">
            </td>
            <td style="text-align:left;">{{ track_a.artist.name }}</td>
            <td style="text-align:left;">{{ track_a.title }}</td>
            <td style="text-align:left;">{{ track_b.title }}</td>
            <td>
                <form method="post" action="{% url 'merge_tracks' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="track_a_id" value="{{ track_a.id }}" />
                    <input type="hidden" name="track_b_id" value="{{ track_b.id }}" />
                    <button type="submit" class="btn btn-primary" style="background-color:#283C4F; color:white; border:none;">Merge</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
    
</form>

<script>
function toggleSelectAll(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.merge-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateBulkMergeButton();
}

function updateBulkMergeButton() {
    const checkedBoxes = document.querySelectorAll('.merge-checkbox:checked');
    const bulkBtn = document.getElementById('bulk-merge-btn');
    const count = checkedBoxes.length;
    bulkBtn.textContent = `Merge selected (${count})`;
    bulkBtn.disabled = count === 0;
}

function bulkMerge() {
    const checkedBoxes = document.querySelectorAll('.merge-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one pair to merge.');
        return;
    }
    
    if (confirm(`Are you sure you want to merge ${checkedBoxes.length} pair(s) of tracks?`)) {
        document.getElementById('bulk-merge-form').submit();
    }
}

// Add event listeners to update button
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.merge-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkMergeButton);
    });
    updateBulkMergeButton(); // Initialize button
});
</script>
{% endblock %}
